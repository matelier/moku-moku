# 単位胞最適化

単位胞最適化の際には、

    ストレス補正付きの同時最適化

の利用をお勧めします。

PHASE/0付属サンプルでは、`unitcell_optimization/TiO2_with_correction_sametime`を参考にしてください。

PHASE/0入力ファイルには

```C
structure_evolution {
    stress {
        sw_stress_correction = on  ! ストレス補正
        delta_ecut = 1.0 Rydberg  ! 補正に用いるエネルギー変化量
    }
    lattice {
        sw_optimize_lattice = on
        sw_optimize_coords_sametime = on  ! 単位胞と原子位置の同時最適化
    }
}
```

と記述します。

## はじめに

かつて、第一原理的に電子状態を求めることは、基礎的な単結晶を対象とした場合でさえ負荷が高い計算でした。
そして、実験から知られている単位胞を採用し、その内部の原子配置を最適化すれば、実験と比較可能な電子状態計算結果を得ることができたので、単位胞を計算から求めることは稀でした。
また、GGA-PBEを使用すると、計算から求まる格子長さは、実験値と比べて数%過大評価される傾向があります。
既知の結晶構造を対象とした第一原理計算では、単位胞の最適化は計算負荷に比して効果が乏しいことも、同機能が頻繁には利用されない理由の一つでした。

現在では、計算機の性能向上とソフトウェアのアルゴリズム改良が相まって、単位胞を計算で求めることが実用的になりました。
さらに近年は、実験結果がない（未知の）物質が計算対象になっており、その場合は単位胞を含む構造全体を計算から求めることが要求されます。

PHASE/0はこのような時代の変遷を生き抜いてきたソフトウェアです。
時代の要求に沿って機能が順次追加された結果、サンプルやマニュアルには継ぎ足し感が残っています。
以下に経緯を紹介しますので、理解を深める参考にしてください。

## 第一世代：単位胞最適化

安定な単位胞を求める計算には、異なる二つの考え方があります。

- 単位胞を変形させながら、エネルギー最小を探索する
- ストレステンソルの全成分がゼロになる単位胞を探索する

前者は、全エネルギーさえ計算できれば、実行可能な方法です。
対称性が高く格子の自由度が小さい場合は実行しやすく、特に立方晶では、最適化の対象は一辺の長さのみなので[実用的に利用されます](https://github.com/matelier/moku-moku/tree/master/shell_script#%E5%88%A9%E7%94%A8%E4%BE%8B)。
けれども対称性が低下すると、最大で6パラメータの最適化になりますので、効率的ではありません。
一般には、後者のストレステンソルのゼロを探す方法が有力で、PHASE/0にもその機能が実装されました。

単位胞最適化が実装される以前は、「構造緩和」と言えば、単位胞内部の原子配置を最適化することでした。
その手順を以下に示します。

1. 電子状態が収束した後に原子に作用する力を求めます。
1. 力が作用する方向に原子を移動させます。
1. 新たな原子配置で、電子状態を計算します。
1. 1.から3.を、原子に作用する力が十分に小さくなるまで繰り返します。

PHASE/0に最初に実装された単位胞最適化機能は、上記計算が終了した後に、ストレステンソルを計算し、各成分がゼロに近づくように単位胞を変形する方法でした。
単位胞を変形する毎に、上記従来の「構造緩和」を繰り返して実行します。

### ストレスの計算精度

第一世代の方法では、ストレスの計算精度が低いことが課題でした。

PHASE/0は平面波基底を採用しています。
平面波の細かさの上限はカットオフエネルギーで指定され、この数値が大きいほど計算精度が高く（基底関数が多く）なります。
計算で求める物理量のカットオフエネルギー依存性を評価すると、ある程度のカットオフエネルギーの大きさで目的とする物理量が収束することが期待できます。
カットオフエネルギーが大きいほど計算負荷が高くなるので、大きければ良いものではありません。
実用的な計算負荷で収束した物理量が得られる、適切な大きさのカットオフエネルギーを選択することが重要です。

ところで、ストレステンソルの計算は、カットオフエネルギーに対する収束性が悪いことが知られています。
そのため、（全エネルギーの差や、原子に作用する力の計算向けに）推奨されているカットオフエネルギーを用いた計算では、ストレステンソル各成分の計算精度が低い、という問題が生じます。
精度が低いストレス値を指標に最適化した単位胞に、高い計算精度はありません。

単位胞を精度良く求めるためには、大きなカットオフエネルギーを使わなければなりません。
その例が`unitcell_optimization/TiO2`です。
これは計算負荷の増大を招き、使い勝手が良くありません。

## 第二世代：ストレス補正付き最適化

これを克服するためにPHASE/0に実装された機能が、「ストレス補正」です。

カットオフエネルギーを変化させた時の全エネルギー変化量から、ストレステンソルの補正量を求めます。

入力ファイルでは、本計算向けのカットオフエネルギー（波動関数；`cutoff_cd`）を指定します。
ストレス補正値を求める計算では、最初にカットオフエネルギーを小さくした（`cutoff_cd` - `delta_ecut`）SCF計算を行い、エネルギーを求めます。
次に、カットオフエネルギーを大きくした（`cutoff_cd` + `delta_ecut`）SCF計算を行い、エネルギーを求めます。
異なる二つのカットオフエネルギーで計算したエネルギーの差から、ストレスの補正量（スカラー）が求まります。
補正では、ストレステンソルの対角成分に、同一の補正量を加えます。

この補正は効果的で、ストレス計算用に特別に大きなカットオフエネルギーを利用することなしに、実用的な単位胞最適化ができるようになりました。

実施例は`unitcell_optimization/TiO2_with_correction`です。

改めて、格子最適化の計算手順を示します。
ストレスの計算精度が向上した以外は、第一世代と同じです。

0. ストレス補正量を求めます。（カットオフエネルギーを変更したSCF計算を二回実施）
1. 単位胞内部の原子位置を最適化します。
2. ストレステンソルを計算します。
3. ストレステンソル（補正あり）の各成分の絶対値が小さくなるように、単位胞を変形します。
4. 1.の原子位置の最適化に戻ります。収束条件を満たすまで繰り返します。

## 第三世代：単位胞と原子位置の同時最適化

第二世代の単位胞最適化では、原子位置の最適化と、単位胞の更新が分離されています。
単位胞内部の原子位置を精度良く最適化しても、単位胞が変形すれば、再び原子に力が作用するでしょう。
これら二つを分離して実施することは、必ずしも適切ではなさそうです。
そこで、これら二つの最適化を並行して実施する機能が追加されました。
その例が`unitcell_optimization/TiO2_with_correction_sametime`です。
以下の手順で計算が進みます。

0. ストレス補正量を求めます。
1. 電子状態が収束した後に、原子に作用する力と、単位胞に作用するストレスを計算します。
2. 原子に作用する力と、格子に作用するストレスがゼロに近づくように、単位胞とその内部の原子位置を更新します。
3. 収束条件を満たすまで繰り返します。

単位胞を最適化する際には、この方法の使用をお勧めします。
