# ベーダー電荷解析

ベーダー電荷についての一般的な説明は、[こちら](https://www.asms.co.jp/application/analyzer.html#bader)を参照してください。
擬ポテンシャル法との組み合わせで生じる**問題点**が指摘されていますが、ここではそれを克服する方法をご紹介します。

## 内殻電子を考慮したベーダー電荷解析

問題の原因は、

- 擬ポテンシャル法が出力する電荷密度は内殻電子の寄与を含まないため、
- 原子核近傍で電荷密度を過小評価した結果、
- 原子間の空間分割位置を適切に認識しないこと

でした。

この問題を回避するために、二種類の電荷密度を用意します。

- 価電子の電荷密度分布（内殻電子を含みません）：
PHASE/0で**実空間電荷密度分布**といえば、通常はこれを指します。
- 内殻の電子密度を含む、全電子（相当）の電荷密度分布：
内殻電子の寄与を含みます。
標準的な計算条件では、原子核近傍での内殻電子の急峻な密度変化を記述するには、メッシュの細かさが不足する傾向があります（後述）。

後者を出力するためには、入力ファイル`postprosessing - charge`ブロックに、以下の記述を加えます。

```C
         sw_add_corecharge_rspace = on
```

本サンプルはディレクトリ名が示す通り、4H-SiCを対象にベーダー電荷解析を行います。
SCF計算を実行します。

```sh
mpiexec -np 4 ../../../../bin/phase ne=1 nk=4
```

実空間の電荷密度分布（CUBE形式）`nfchr.data`と`nfchr_ae.data`が出力されていることを確認してください。

```sh
$ ls nfchr*.data
nfchr.data	nfchr_ae.data
```

前者が（通常の）価電子の、後者は価電子に加えて内殻電子の寄与を含む密度分布です。

`bader`解析プログラムには、CUBE形式の電荷密度を与えます。
最初に、価電子の電荷密度分布に対してベーダー電荷解析を実行し、先に述べた**問題**を再現します。

```sh
PATH_TO_BADER/bader nfchr.data
```

分割結果は`ACF.dat`に出力されます。

```C
    #         X           Y           Z       CHARGE      MIN DIST   ATOMIC VOL
 --------------------------------------------------------------------------------
    1    0.000000    0.000000   19.212006    0.000000     0.000000     0.000000
    2    0.000000    0.000000    9.604503    0.000000     0.000000     0.000000
    3    0.000000    0.000000    3.599054    8.004764     2.603627   143.455952
    4    0.000000    0.000000   13.206557    8.004716     2.603627   143.450765
    5    0.000000    3.389910    4.801577    0.000000     0.000000     0.000000
    6    2.935748    1.694955   14.409079    0.000000     0.000000     0.000000
    7    0.000000    3.389910    8.415560    7.995284     2.620483   143.388517
    8    2.935748    1.694955   18.023063    7.995236     2.620483   143.383329
 --------------------------------------------------------------------------------
    VACUUM CHARGE:               0.0000
    VACUUM VOLUME:               0.0000
    NUMBER OF ELECTRONS:        32.0000
```

Si （原子1, 2, 5, 6）が占める体積（`ATOMIC VOL`）が0.0、その体積内の電荷積分値（`CHARGE`）も0.0です。
これは、意図せぬ結果ではないでしょうか。

Siの体積がゼロになるのは、擬ポテンシャル法が内殻電子を扱わないため原子核近傍で電荷密度を過小評価するから、でした。
すなわち内殻電子を含む電荷密度分布を利用すれば、原子間の空間分割位置を正しく評価できそうです。
それを実現するのが、以下のコマンドです。

```sh
PATH_TO_BADER/bader nfchr.data -ref nfchr_ae.data
```

結果を見てみましょう。

```C
    #         X           Y           Z       CHARGE      MIN DIST   ATOMIC VOL
 --------------------------------------------------------------------------------
    1    0.000000    0.000000   19.212006    1.432097     1.129715    35.969032
    2    0.000000    0.000000    9.604503    1.431987     1.129715    35.958657
    3    0.000000    0.000000    3.599054    6.550513     1.818441   106.480576
    4    0.000000    0.000000   13.206557    6.550299     1.818441   106.475389
    5    0.000000    3.389910    4.801577    1.451288     1.120385    36.939065
    6    2.935748    1.694955   14.409079    1.451465     1.120385    36.939065
    7    0.000000    3.389910    8.415560    6.566212     1.826095   107.460984
    8    2.935748    1.694955   18.023063    6.566139     1.826095   107.455796
 --------------------------------------------------------------------------------
    VACUUM CHARGE:               0.0000
    VACUUM VOLUME:               0.0000
    NUMBER OF ELECTRONS:        32.0000
```

Si原子にも、ゼロでない体積が割り当てられました。
また、Bader電荷の値は、上記リンク先の2H-SiCに対する全電子計算の結果に近く、解析が適切なことを示唆します。

| Bader電荷 | 従来法 | 改良法 |
| :-------------: | :-------------: | :-------------: |
| Si | 0.0 (-4.0) | 1.44 (-2.56) |
|  C | 8.0 (+4.0) | 6.56 (+2.56) |

最後に、`nfchr_ae.data`だけでは正しい結果が得られないことも確認しましょう。

```sh
PATH_TO_BADER/bader nfchr_ae.data
```

空間分割は2番目の実行例と同一ですが、電荷の総量（`NUMBER OF ELECTRONS`）が正しくないので、それを分割した各原子の電荷も間違っています。
この主たる要因は、原子核近傍に局在した内殻電子の密度（電荷密度の急峻な変化）を正しく扱うためには、メッシュが粗すぎることです。
電荷の積分には適さない一方で、原子核から少し離れさえすれば、内殻電子を含む正しい電荷密度を表現していることが期待できますので、原子の空間（Bader）分割には適します。

```C
    #         X           Y           Z       CHARGE      MIN DIST   ATOMIC VOL
 --------------------------------------------------------------------------------
    1    0.000000    0.000000   19.212006   18.617178     1.129715    35.969032
    2    0.000000    0.000000    9.604503   18.617068     1.129715    35.958657
    3    0.000000    0.000000    3.599054    8.653621     1.818441   106.480576
    4    0.000000    0.000000   13.206557    8.653404     1.818441   106.475389
    5    0.000000    3.389910    4.801577   11.126066     1.120385    36.939065
    6    2.935748    1.694955   14.409079   11.126246     1.120385    36.939065
    7    0.000000    3.389910    8.415560    8.544993     1.826095   107.460984
    8    2.935748    1.694955   18.023063    8.544920     1.826095   107.455796
 --------------------------------------------------------------------------------
    VACUUM CHARGE:               0.0000
    VACUUM VOLUME:               0.0000
    NUMBER OF ELECTRONS:        93.8835
```

以上のように、原子毎に空間を分割する際には`nfchr_ae.data`を用いて、その空間内部の電荷を積算（積分）する際には`nfchr.data`を用いることにより、（全電子計算と同等な）適切な結果を得ることができました。
