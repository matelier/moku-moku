# スーパーセルとk点分割数の関係

## はじめに

k点分割数は、周期系の第一原理計算において計算精度に影響を及ぼす重要なパラメータです。
その重要性にもかかわらず、固体物理学に馴染みのない方にも分かるように説明するのは容易ではありません。
[こちら](https://matelier.github.io/kpoint_sampling/)で説明を試みました。

ここでは、k点分割数の（理論的な）意味は（ひとまず）置いて、電子状態計算を実務に利用したい方に向けて、どのような値を採用するのが（実用的な観点から）適切なのか、説明します。

- 実格子が大きいほど、小さなk点分割数を用います。
- 実格子長さとk点分割数を反比例させると、計算精度は一定に保たれます。

鉄（体心立方格子）を題材に、その関係を詳しく調べます。
前半ではBravais格子を、単位格子として考えます。
スーパーセルの計算でk点分割数を適切に選ぶと、計算結果（1原子あたりのエネルギー）が単位格子での計算結果と数値誤差の範囲で一致することを確認します。

後半で、Bravais格子と基本格子のk点分割の関係を説明します。
実用上はそれほど重要ではありませんが、理解を深めるために有益です。
体心立方格子の鉄を表現する最小の繰り返し単位は、鉄1原子から構成される基本格子ですが、基本格子とBravais格子の関係は、各軸の「整数倍」では表現できません。
そのような両者の関係を、全エネルギーのk点分割数依存性に注目して説明します。

以下、エネルギーの単位はHartreeです。
擬ポテンシャルは、`Fe_ggapbe_paw_us_02.pp`を用いました。

## Bravais格子の計算

鉄（体心立方格子；強磁性）のBravais格子（立方体）には、原子が二つ納まります。
k点分割数は各方向に12にしました。
12は、2, 3, 4 (, 6)で割り切れるので、本実験に適しています。

```C
mesh { nx = 12, ny = 12, nz = 12}
```

格子定数を最適化すると、5.3621 bohrと求まりました。
以下ではこの値を適宜整数倍して用います。

## スーパーセル

Bravais格子を、縦・横・高さ方向に整数倍したスーパーセルを作成します。
三種類のスーパーセルを作成しました。

- 全ての軸を2倍したスーパーセル： 2x2x2 計16原子
  - nx = 6, ny = 6, nz = 6
- 全ての軸を3倍したスーパーセル： 3x3x3 計54原子
  - nx = 4, ny = 4, nz = 4
- 各軸を2, 3, 4倍したスーパーセル： 2x3x4 計48原子
  - nx = 6, ny = 4, nz = 3

1原子あたりのエネルギーを比較します。
PHASE/0にはk点分割の手法が二つ（`monk`と`mesh`）用意されています。
その両方で、比較しました。

<!-- | | Bravais | 2x2x2 | 3x3x3 | 2x3x4 |
| :-------------: | :-------------: | :-------------: | :-------------: | :-------------: |
| monk | -70.84545461 | -70.84545451 | -70.84545452 | -70.84545452 |
| mesh | -70.84546330 | -70.84546321 | -70.84546321 | -70.84546321 | -->

|         | monk         | mesh         |
| :-------------: | :-------------: | :-------------: |
| Bravais | -70.84545461 | -70.84546330 |
| 2x2x2   | -70.84545451 | -70.84546321 |
| 3x3x3   | -70.84545452 | -70.84546321 |
| 2x3x4   | -70.84545452 | -70.84546321 |

k点分割手法が同じであれば、計算結果は数値誤差の範囲で（上記例では小数点以下6桁まで）一致します。
k点分割手法によるエネルギー差は、数値誤差よりも大きく、小数点以下5桁目に違いを生じています。
後ほど示すように、分割数が十分に大きければ、k点分割手法に依る差が小さくなる傾向があります。
ここで採用した分割数は（十分と言えるかどうかは用途によりますが、小さくはなく）大きいので、分割手法に依る差は目立ちません。

## 注意：四面体法（tetrahedral）の利用

四面体法（`tetrahedral`）を用いる場合には注意が必要です。

第一原理計算では電子状態を離散化して扱います。
その各準位のエネルギー固有値をそのまま計算に用いると不安定になることが多いため、実用的には各固有値を「ぼかし」ます（`smearing`）。
「ぼかし」を導入することにより、フェルミエネルギー近傍で準位の部分占有を許容します。
`smearing`にはいくつか方法が用意されています。
PHASE/0の既定値は`parabolic`であり、各固有値に二次関数でエネルギー幅を持たせます。
上記計算ではこれを用いました。
一方、`tetrahedral`では、異なるk点のエネルギー固有値の補間により「ぼかし」ます。
補間（ぼかし）に四面体を利用することが、その計算手法名の由来です。

先の計算で示したように、スーパーセルの計算において、k点分割数を適切に選べば、k点の座標は等価にできます。
しかしながら`tetrahedral`を用いたスーパーセルの計算において、補間のための**四面体を構成する頂点の組み合わせ**を保つことはできません。
四面体の構成が変われば補間結果が変わるため、全エネルギーは一致しません。
前節のスーパーセルの計算を、`smearing`に`tetrahedral`を指定して再計算した結果を示します。
数値誤差を超えて、エネルギーが変わることが確認できます。

|    | tetrahedral |
| :----------: | :----------: |
| Bravais | -70.84489950 |
| 2x2x2   | -70.84519296 |
| 3x3x3   | -70.84538216 |
| 2x3x4   | -70.84537255 |

ただし、バンドギャップがある系では、四面体法を用いても（数値誤差の範囲で）一致する結果が得られます。
四面体法が**線型補間**だからです。
バンドギャップのある系では、専有／非占有の組み合わせは変化しないので、補間結果の総和（積分値）は頂点の固有値の総和に一致します。
そのためバンドギャップがある系では`tetrahedral`を用いても、1原子あたりのエネルギーは（数値誤差の範囲で）一致します。

フェルミ面がある、金属的な電子状態の場合に、特に注意してください。

## Bravais格子と基本格子のk点分割の関係

Bravais格子と基本格子の関係は、各軸の整数倍ではありません。
碁盤の目（の三次元版）のk点サンプリングでは、Bravais格子と基本格子のk点の座標を等価にすることはできません。
<!-- k点分割数を十分に大きくすると、k点座標が異なる影響は小さくなりますが、計算負荷の増大を招き、好ましくない場合があります。 -->

ところでPHASE/0は、k点分割手法に`mesh`を用いた基本格子の計算では、実格子がBravais格子よりも小さくなった分だけ、自動的にk点を増やします。
例えば、体心立方格子では基本実格子の体積はBravais格子の1/2ですので、k点数を2倍にします；面心立方格子では基本実格子の体積は1/4で、k点数を4倍にします（いずれもk点数は、空間群を利用する削減前の値です）。

すなわち、k点分割手法を`mesh`にすると、Bravais格子と基本格子で、入力ファイルで同じk点分割数を指定して、計算精度は「同じ」になります。
例えば、1原子あたりのエネルギーは、数値誤差の範囲で一致します。

| | | 8x8x8 | 12x12x12 | 16x16x16 | 24x24x24 | 32x32x32 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| mesh | 基本格子 | -70.84533771 | -70.84546318 | -70.84547533 | -70.84544422 | -70.84544803 |
|  | Bravais | -70.84533782 | -70.84546330 | -70.84547545 | -70.84544434 | -70.84544814 |
| monk | 基本格子 | -70.84599645 | -70.84543412 | -70.84559693 | -70.84547126 | -70.84545447 |
|  | Bravais | -70.84546139 | -70.84545461 | -70.84542512 | -70.84545160 | -70.84545322 |

`mesh`の計算では、Bravais格子の1原子あたりのエネルギーは、基本格子のエネルギーと数値誤差の範囲で一致します（上記例で小数点以下6桁まで一致）。
`monk`には、そのような性質はありません。
また、分割数が多くなると、`mesh`と`monk`の差、`monk`のBravais格子と基本格子の差が、いずれも小さくなる傾向があります。
k点が稠密になれば、その座標の違いが計算結果に及ぼす影響は小さくなります。

PHASE/0以外の第一原理計算ソフトウェアには、k点数を増やす機能が備わっている場合があります。
（後日追記予定）

## まとめ

単位格子を整数($n$)倍したスーパーセルの計算では、k点分割数を $\frac{1}{n}$すると、計算精度は等価です。
エネルギーなどの計算結果を比較する際には、計算精度を揃えることが重要です。
k点分割数依存性が収束する程度に稠密なk点を採用すると計算負荷が高くなってしまうことが多いので、適度なk点分割数を採用しつつ、実用的に等価とみなせる計算精度になるように工夫してください。
